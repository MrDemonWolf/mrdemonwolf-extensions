name: PR Build

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate dev version
        id: version
        run: |
          base_version=$(grep -oP "Version:\s*\K[0-9.]+" mrdemonwolf-extensions.php)
          short_sha=$(echo "${{ github.event.pull_request.head.sha }}" | cut -c1-7)
          dev_version="${base_version}-dev.${short_sha}"
          echo "dev_version=${dev_version}" >> "$GITHUB_OUTPUT"

      - name: Build ZIP
        run: |
          mkdir -p build/mrdemonwolf-extensions
          cp -r mrdemonwolf-extensions.php includes assets readme.txt CHANGELOG.md LICENSE.md build/mrdemonwolf-extensions/

          # Stamp dev version into the plugin header
          sed -i "s/Version:.*$/Version:     ${{ steps.version.outputs.dev_version }}/" build/mrdemonwolf-extensions/mrdemonwolf-extensions.php

          cd build
          zip -r ../mrdemonwolf-extensions-${{ steps.version.outputs.dev_version }}.zip mrdemonwolf-extensions/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mrdemonwolf-extensions-${{ steps.version.outputs.dev_version }}
          path: mrdemonwolf-extensions-${{ steps.version.outputs.dev_version }}.zip
